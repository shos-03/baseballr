---
title: "strike"
output: html_document
date: "2022-09-25"
---

大谷の1試合分のデータ
```{r}
sho_id <- playerid_lookup(last_name = "Ohtani", first_name = "Sho") %>% 
  pull(mlbam_id)
data <- statcast_search_pitchers(start_date = '2022-09-20',
                                 end_date = '2022-09-26',
                                 pitcherid =  sho_id)

sho_data <- data %>% select(pitch_type, plate_x, plate_z, sz_top, sz_bot)
```

## pitch_chart
```{r}
ggpitchchart <- function(data,
                         x_value = "plate_x",
                         z_value = "plate_z",
                         sz_top = NULL,
                         sz_bot = NULL,
                         lim = NA,
                         color_value = NULL,
                         density = FALSE,
                         bin_size = 8,
                         scall_fill_palette = "Blues",
                         point_size = 10,
                         point_alpha = 0.75,
                         div9 = TRUE,
                         base = FALSE,
                         title = NULL) {
  
  x1 <- x2 <- y1 <- y2 <- NULL
  
  strike_zones <- data.frame(
    x1 = rep(c(-0.83, -0.25, 0.25), each = 3),
    x2 = rep(c(-0.25, 0.25, 0.83), each = 3),
    y1 = rep(c(-0.83, -0.25, 0.25), 3),
    y2 = rep(c(-0.25, 0.25, 0.83), 3)
  )
  
  
  plot <- ggplot()+
    xlim(-lim, lim) + ylim(-lim, lim)+
    xlab("") + ylab("") +
    coord_fixed(ratio = 1) +
    theme(panel.background = element_blank(), axis.text = element_blank(), axis.ticks = element_blank(),
          plot.title = element_text(face = "bold", size = 25))
  
  if(!is.null(title)){
    plot <- plot +
      labs(title = title)
  }
  
  if(base){
    base <- data.frame(
  x = c(0, -1, -0.83, 0.83, 1),
  y = c(-2.4, -2.1, -1.66, -1.66, -2.1))
    
    plot <- plot +
      geom_polygon(base, mapping=aes(x=x, y=y), fill = "gray")
  }
  
  if(!density){
    plot <- plot+
      theme(legend.position = "right", legend.text = element_text(size = 17), legend.title = element_text(size = 17))
    
    if(div9){
      plot <- plot+
        geom_rect(data = strike_zones, aes(xmin = x1, xmax = x2, ymin = y1, ymax = y2), fill = "white", color = "gray20")
    }else{
      plot <- plot+
        geom_rect(aes(xmin = -0.83, xmax = 0.83, ymin = -0.83, ymax = 0.83), fill = NA, color = "gray20")
    }
    
    if(is.null(color_value)){
      if(!is.null(sz_top) && !is.null(sz_bot)){
        plot <- plot+
          geom_point(data = data, mapping = aes_string(x = x_value, y = paste("(1.66*(",z_value,"-",sz_bot,")/(",sz_top,"-",sz_bot,")-0.83)")),color = "blue", alpha = point_alpha, size = point_size)
      }else{
        plot <- plot+
          geom_point(data = data, mapping = aes_string(x = x_value, y = paste("(1.66*(",z_value,"-1.57)/(3.39-1.57)-0.83)")), color = "blue", alpha = point_alpha, size = point_size)
      }
    }else{
      
      if(!is.null(sz_top) && !is.null(sz_bot)){
        plot <- plot+
          geom_point(data = data, mapping = aes_string(x = x_value, y = paste("(1.66*(",z_value,"-",sz_bot,")/(",sz_top,"-",sz_bot,")-0.83)"), color = color_value), alpha = point_alpha, size = point_size)
      }else{
        plot <- plot+
          geom_point(data = data, mapping = aes_string(x = x_value, y = paste("(1.66*(",z_value,"-1.57)/(3.39-1.57)-0.83)"), color = color_value), alpha = point_alpha, size = point_size)
      }
    }
    
  }else{
    plot <- plot+
      theme(legend.position = "none")
    
    if(!is.null(sz_top) && !is.null(sz_bot)){
      plot <- plot+
        geom_density_2d_filled(data = data, aes_string(x = x_value, y = paste("(1.66*(",z_value,"-",sz_bot,")/(",sz_top,"-",sz_bot,")-0.83)")), bins = bin_size, alpha = 0.5)+
        scale_fill_brewer(palette = scall_fill_palette)
    }else{
      plot <- plot+
        geom_density_2d_filled(data = data,aes(x = x_value,y = paste("(1.66*(",z_value,"-1.57)/(3.39-1.57)-0.83)")),bins = bin_size, alpha = 0.5)+
        scale_fill_brewer(palette = scall_fill_palette)
    }
    
    if(div9){
      plot <- plot+
        geom_rect(data = strike_zones, aes(xmin = x1, xmax = x2, ymin = y1, ymax = y2), fill = NA, color = "gray20")
    }else{
      plot <- plot+
        geom_rect(aes(xmin = -0.83, xmax = 0.83, ymin = -0.83, ymax = 0.83), fill = NA, color = "gray20")
    }
    
  }
  
  return(plot)
}
```

```{r}
ggpitchchart(sho_data, x_value = "plate_x", z_value = "plate_z", sz_top = "sz_top", sz_bot = "sz_bot", color_value = "pitch_type", base = TRUE, title = "Ohtani, 9.24")
ggpitchchart(sho_data, x_value = "plate_x", z_value = "plate_z", sz_top = "sz_top", sz_bot = "sz_bot", lim = 2, density = TRUE, div9 = FALSE, title = "Ohtani, 9.24")
```
```{r}
df2 <- data.frame(
  x = c(0, -1, -0.83, 0.83, 1),
  y = c(-2.4, -2.1, -1.66, -1.66, -2.1)
)
ggpitchchart(sho_data)+
  geom_polygon(df2, mapping=aes(x=x, y=y), fill = "gray")
```


## zone_chart
```{r}
avg <- 0
for(i in 1:9){
  avg[i] <- sum(data$zone == i & data$events %in% c("single", "double", "triple", "home_run"))/sum(data$zone == 1 & data$events %in% c("single", "double", "triple", "k", "home_run", "field_out"))
}
```

```{r}
dTH <- 1:14

sapply(dTH, function(x){sum(zone == x, na.rm = TRUE)})
```


## hex_chart
```{r}
ggplot(data = sho_hits, aes(x = plate_x, y = (2.4*(plate_z-sz_bot)/(sz_top-sz_bot)-1.2))) +
  stat_bin_hex(binwidth = 0.4, geom = "text", aes(color = after_stat(count), size =  after_stat(count)), label = "⬢", family = "STIXTwoMath") +
  coord_fixed(ratio = 1) +
  scale_size(range = c(0,12))+
  theme(panel.background = element_blank(), axis.text = element_blank(), axis.ticks = element_blank())+
  geom_rect(aes(xmin = -0.83, xmax = 0.83, ymin = -1.2, ymax = 1.2), fill = NA, color = "gray") +
  xlab("") + ylab("")+
  labs(title = "Ohtani Hits -2022")
  
```

